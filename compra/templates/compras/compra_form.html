{% extends 'base.html' %}
{% load static %}

{% block content %}
<h2>{% if form.instance.pk %}Editar{% else %}Crear{% endif %} Compra</h2>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}
    <select id="cliente-results"></select>
    <div id="productos-formset">
        {{ formset.management_form }}
        {% for form in formset %}
            <div class="producto-form">
                {{ form.as_p }}
            </div>
        {% endfor %}
    </div>
    <button type="button" id="add-producto">Agregar Producto</button>
    <button type="submit">Guardar</button>
    <a href="{% url 'compra:compra_list' %}">Cancelar</a>
</form>

<p>Total: $<span id="total">0.00</span></p>

<div id="formset-data" data-total-forms="{{ formset.total_form_count }}"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    
    $(document).ready(function() {
        // Búsqueda de clientes en tiempo real
        $('#id_cliente').on('input', function() {
            var query = $(this).val();
            $.ajax({
                url: '{% url "compra:buscar_cliente" %}',
                data: {
                    'query': query
                },
                dataType: 'json',
                success: function(data) {
                    var results = data.results;
                    var dropdown = $('#cliente-results');
                    dropdown.empty();
                    $.each(results, function(i, item) {
                        dropdown.append($('<option></option>').attr('value', item.id).text(item.nombre + ' - ' + item.telefono));
                    });
                }
            });
        });
    
        // Adición dinámica de productos
        //var formCount = {{ formset.total_form_count }};
        var formCount = parseInt($('#formset-data').data('totalForms'));
        $('#add-producto').click(function() {
            var form = $('.producto-form:first').clone(true);
            form.find('input').val('');
            form.find('input:first').attr('name', form.find('input:first').attr('name').replace('-0-', '-' + formCount + '-'));
            $('#productos-formset').append(form);
            $('#id_form-TOTAL_FORMS').val(formCount + 1);
            formCount++;
        });
    
        // Eliminación de productos
        $(document).on('click', '.remove-producto', function() {
            $(this).closest('.producto-form').remove();
            updateTotal();
        });
    
        // Cálculo del total
        $(document).on('input', '.cantidad, .precio', function() {
            updateTotal();
        });
    
        function updateTotal() {
            let total = 0;
            $('.producto-form').each(function() {
                let cantidad = parseFloat($(this).find('.cantidad').val()) || 0;
                let precio = parseFloat($(this).find('.precio').val()) || 0;
                total += cantidad * precio;
            });
            $('#total').text(total.toFixed(2));
        }
    });
    </script>
{% endblock %}